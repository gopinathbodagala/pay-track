/*
 *  created by Rainer Link <rainer_link@intuit.com>
 *  version 1.16   9/14/11 - Updated touchEnd() to accomodate jQuery Mobile 1.0b3 switching from vclick to click for links and fixed external linking bug
 *                12/7/11 - Modified touchEnd() to better support JQM checkboxes and radio buttons
 *                12/22/11 - Modified touchStart() to work with links that launch native apps (phone, maps)
 *                2/15/12 - pull down to refresh 
 */

 (function($){function VTouchScroll(el,opt){const ua=navigator.userAgent,droid=ua.match(/Android/i)?true:false,ipad=ua.match(/iPad/i)?true:false,ipod=ua.match(/iPod/i)?true:false,iphone=ua.match(/iPhone/i)?true:false,touch=(droid||ipad||ipod||iphone);var that=this,el=$(el),scrl=el.children().eq(0),sb=opt.scrollBar,sbOpacity,scrlPos,prevY,speed,timer,startScrlPos,startPos,decelerating=false,scrolling=false,firstScrl,tracking=false,elHeight,scrlHeight,ratio,maxScrl,touchStart,refreshPanel,refreshPanelHeight,refreshArrow,refreshLabel,pullDown=true;transformY(scrl,0);if(sb){transformY(sb=$('<div class="vTouchScrollBar" style="display:none;visibility:hidden"></div>').appendTo(el),0);sbOpacity=sb.css('opacity');}
 el[0].addEventListener(touch?'touchstart':'mousedown',touchStart,false);el[0].addEventListener(touch?'touchmove':'mousemove',touchMove,false);el[0].addEventListener(touch?'touchend':'mouseup',touchEnd,false);el[0].addEventListener('touchcancel',function(){tracking=false;hideSB();globalTapReady=true;},false);if(opt.pullRefresh){refreshPanel=el.find('.pullRefresh');if(refreshPanel.length==1){refreshPanelHeight=refreshPanel.height();refreshArrow=refreshPanel.find('img').eq(0);refreshLabel=refreshPanel.find('.pullRefreshTxt');refreshPanel.css('backgroundPosition','-100px');}else{refreshPanel=null;}}
 function touchStart(e){var targ=$(e.target);if(tracking)return;if(decelerating){globalTapReady=false;e.preventDefault();}
 tracking=true;clearInterval(timer);if(!targ.closest('select').length&&!targ.is('a[href^="tel:"]')&&!targ.is('a[href^="http://maps.google.com"]'))e.preventDefault();scrolling=decelerating;firstScrl=decelerating;decelerating=false;speed=0;refreshGlobals();if(scrlPos>0||(scrlPos<-maxScrl&&scrlHeight>elHeight)||(scrlPos<0&&scrlHeight<elHeight)){scrlPos=(scrlPos>0||(scrlPos<0&&scrlHeight<elHeight))?0:-maxScrl;scrolling=true;moveScrl();}
 startScrlPos=scrlPos;startPos=getPoint(e,this);prevY=startPos.y;touchStart=now();if(sb)transformY(sb.stop().css('height',elHeight*ratio-2),-scrlPos*ratio);};function touchMove(e){if(!tracking)return;e.preventDefault();var pos=getPoint(e,this),deltaY=pos.y-startPos.y;if(!scrolling){if(abs(deltaY)>7){scrolling=true;firstScrl=true;globalTapReady=false;if(sb&&scrlHeight>elHeight){sb.css({'opacity':sbOpacity,'display':'block','visibility':'visible'});}
 el.trigger('scrollstart');var btn=$(e.target).closest('.ui-btn');if($.mobile&&btn.length)btn.trigger('mouseout');}else if(abs(pos.x-startPos.x)>25&&e.touches&&e.touches.length==1&&(now()-touchStart<1000)&&opt.triggerSwipe){tracking=false;hideSB();var targ=e.target;while(targ&&targ.nodeType!=1){targ=targ.parentNode;}
 $(targ).trigger('swipe');}}
 if(scrolling){e.stopPropagation();if(firstScrl){firstScrl=false;startPos=getPoint(e,this);return;}
 scrlPos=startScrlPos+deltaY;speed=prevY-pos.y;prevY=pos.y;if(scrlPos>0){scrlPos/=2;}else if(abs(scrlPos)>maxScrl){if(scrlHeight>elHeight){scrlPos=-maxScrl-(abs(scrlPos)-maxScrl)/2;}else{scrlPos/=2;}}
 moveScrl();}};function touchEnd(e){if(!tracking)return;tracking=false;if(!scrolling){if($.mobile){var $targ=$(e.target),link=$targ.closest('a'),label=$targ.closest('label[for]'),tappable=$targ.closest('.tappable');if(tappable.length){tappable.addClass('tapactive');setTimeout(function(){try{tappable.removeClass('tapactive');}catch(e){}},2000);}
 if(link.length){if(link.attr('rel')=='external'){location.href=link.attr('href');}
 link.trigger('click');hideSB();return true;}else if(label.length){label.trigger('mouseout').trigger('click');hideSB();e.preventDefault();e.stopPropagation();return true;}}
 if(!opt.triggerTap||now()-touchStart>1000)return;var targ=e.target;while(targ&&targ.nodeType!=1){targ=targ.parentNode;}
 $(targ).trigger('tap');hideSB();return true;}
 scrolling=false;if(abs(speed)>2){var step=speed,f=max(0,opt.friction),friction,lastTime=now(),x=.2,m;decelerating=true;clearInterval(timer);timer=setInterval(function(){var time=now(),delta=time-lastTime;lastTime=time;if(scrlPos-step>0||abs(scrlPos-step)>maxScrl){if(x==.2)x=abs(step/10);m=(delta<33)?1-max(scrlPos-step,abs(scrlPos)-maxScrl)/(x*100):.8;if(m<.01)m=.01;if(m>.99)m=.99;step*=m;scrlPos-=step/2;}else{scrlPos-=step;}
 friction=f*max(1,delta/30);step*=max(.001,1-friction);if(abs(step)<x){decelerating=false;if(scrlPos>0){snapTop();}else if(abs(scrlPos)>maxScrl){if(scrlHeight>elHeight)snapBottom();else snapTop(true);}else{endScrl(true);}}else{moveScrl();}},15);}else if(scrlPos>0){snapTop();}else if(abs(scrlPos)>maxScrl){if(scrlHeight>elHeight)snapBottom();else snapTop(true);}else{endScrl(false);}};function getTransformY($el){var s=$el[0].style.webkitTransform.match(/translate3d\(.*\)/);if(s.length===0)return 0;s=s[0].match(/\,.*\,/)[0].match(/\-*\d+/);if(s.length===0)return 0;return s[0]*1;};function refreshGlobals(){elHeight=el.height();scrlHeight=scrl.height();maxScrl=max(0,scrlHeight-elHeight);ratio=elHeight/scrlHeight;scrlPos=getTransformY(scrl);};function snapTop(reverse){clearInterval(timer);var step=scrlPos/6,x=.9,lastTime=now();timer=setInterval(function(){var time=now(),delta=time-lastTime;lastTime=time;step=reverse?Math.min(-1,step*x):max(1,step*x);x*=.989;scrlPos-=step*max(1,delta/30);if((reverse&&scrlPos>=0)||(!reverse&&scrlPos<=0)){scrlPos=0;endScrl(true);}else{moveScrl();}},15);};function snapBottom(){clearInterval(timer);var step=(abs(scrlPos)-maxScrl)/6,x=.9,lastTime=now();timer=setInterval(function(){var time=now(),delta=time-lastTime;lastTime=time;step=max(1,step*x);x*=.989;scrlPos+=step*max(1,delta/30);if(abs(scrlPos)<=maxScrl){scrlPos=-maxScrl;endScrl(true);}else{moveScrl();}},15);};function moveScrl(){if(sb)transformY(sb,-scrlPos*ratio);if(refreshPanel){if(scrlPos>refreshPanelHeight&&pullDown){if(tracking){pullDown=false;refreshLabel.text('Release to refresh...');refreshArrow.css('webkitTransform','rotate(-180deg)');}}else if(scrlPos<refreshPanelHeight&&!pullDown){pullDown=true;refreshArrow.css('webkitTransform','rotate(0deg)');if(tracking){refreshLabel.text('Pull down to refresh...');}else{hideSB();clearInterval(timer);scrlPos=refreshPanelHeight;refreshLabel.text('Refreshing...');refreshArrow.css('visibility','hidden');refreshPanel.css('backgroundPosition','');el.trigger('pullrefresh',that.afterRefresh);}}
 transformY(refreshPanel,scrlPos-refreshPanelHeight);}
 transformY(scrl,scrlPos);el.trigger('scrollchange',-scrlPos);};function endScrl(m){clearInterval(timer);if(m)moveScrl();hideSB();el.trigger('scrollend',abs(scrlPos));setTimeout(function(){globalTapReady=true;},10);};function hideSB(){if(sb)sb.fadeOut(200);};function getPoint(e,node){var ev=(e.touches&&e.touches.length>0)?e.touches[0]:e;return webkitConvertPointFromPageToNode(node,new WebKitPoint(ev.pageX,ev.pageY));};function transformY($el,y){$el[0].style.webkitTransform='translate3d(0px, '+y+'px, 0px)';};function now(){return new Date().getTime();};function abs(n){return Math.abs(n);};function max(a,b){return Math.max(a,b);};this.scrollTo=function(y){if(y==undefined||isNaN(y))return;var scrlTo=-(abs(y));refreshGlobals();if(-scrlTo>maxScrl)scrlTo=-maxScrl;var d=scrlTo-scrlPos,step=d/12,lastTime=now();var timer=setInterval(function(){var time=now(),delta=time-lastTime;lastTime=time;step*=.95;scrlPos+=step*max(delta/30,1);if(scrlPos<scrlTo||abs(step)<.5){clearInterval(timer);scrlPos=scrlTo;}
 moveScrl();},15);};this.checkBounds=function(){refreshGlobals();if(scrlHeight>elHeight){if(-scrlPos>maxScrl)snapBottom();}else if(scrlPos<0){snapTop(true);}};this.getScrollY=function(){return abs(getTransformY(scrl))};this.afterRefresh=function(){if(!tracking&&!decelerating)snapTop();setTimeout(function(){refreshArrow.css('visibility','');refreshLabel.text('Pull down to refresh...');refreshPanel.css('backgroundPosition','-100px');},99);};};$.fn.extend({vTouchScroll:function(opt){var o=$.extend({friction:.04,scrollBar:true,triggerTap:true,triggerSwipe:true,pullRefresh:false},opt);return this.each(function(){if(!$(this).data('vTouchScroll')){$(this).data('vTouchScroll',new VTouchScroll(this,o));}});},vTouchScrollTo:function(pos){return this.each(function(){$(this).data('vTouchScroll').scrollTo(pos);});},vTouchScrollCheckBounds:function(){return this.each(function(){$(this).data('vTouchScroll').checkBounds();});},vTouchScrollGetY:function(){return $(this).eq(0).data('vTouchScroll').getScrollY();}});})(jQuery);
 